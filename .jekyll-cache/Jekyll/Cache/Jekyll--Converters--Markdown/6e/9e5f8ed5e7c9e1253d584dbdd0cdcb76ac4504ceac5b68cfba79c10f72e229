I"†#<p>BÃ i nÃ y Ä‘Æ°á»£c mÃ¬nh dá»‹ch tá»« blog cá»§a team <a href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-3.html">Google Project Zero</a>.</p>

<p>ÄÃ¢y lÃ  pháº§n cuá»‘i trong series exploit iMessage trÃªn iOS. á» pháº§n má»™t ta Ä‘Ã£ giá»›i thiá»‡u sÆ¡ lÆ°á»£c vá» lá»— há»•ng vÃ  pháº§n hai Ä‘i sÃ¢u vÃ o cÃ¡c phÆ°Æ¡ng phÃ¡p táº¥n cÃ´ng nhÆ° heapspray, leak base address, â€¦</p>

<p>Tá»›i pháº§n ba nÃ y, nhÆ° ta Ä‘Ã£ biáº¿t, ASLR Ä‘Ã£ Ä‘Æ°á»£c bypass, base address cá»§a shared cache Ä‘Ã£ náº±m trong tay vÃ  controlled data cÃ³ thá»ƒ Ä‘Æ°á»£c xáº¿p vÃ o má»™t Ä‘á»‹a chá»‰ chÃ­nh xÃ¡c. Äiá»u cÃ²n láº¡i ta cáº§n lÃ m lÃ  exploit lá»— há»•ng thÃªm má»™t láº§n ná»¯a Ä‘á»ƒ chiáº¿m quyá»n Ä‘iá»u khiá»ƒn.</p>

<p><strong>SÆ¡ lÆ°á»£c</strong>: Má»Ÿ Ä‘áº§u pháº§n ba sáº½ giá»›i thiá»‡u ngáº¯n vá» viá»‡c sá»­ dá»¥ng ObjC Ä‘á»ƒ khai thÃ¡c cÃ¡c thiáº¿t bá»‹ khÃ´ng cÃ³ xÃ¡c thá»±c con trá» (Pointer Authentication - PAC), tiáº¿p Ä‘Ã³ lÃ  Ä‘i sÃ¢u vÃ o má»™t cÃ¡ch khai thÃ¡c cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng ká»ƒ cáº£ khi PAC Ä‘Æ°á»£c kÃ­ch hoáº¡t. Cuá»‘i cÃ¹ng sáº½ lÃ  ká»¹ thuáº­t xÃ¢u chuá»—i láº¡i cÃ¡c kiá»ƒu táº¥n cÃ´ng vá»›i Javascript kernel exploit.</p>

<h1 id="objective-c-remote-code-executer">Objective-C Remote Code Executer</h1>

<p>ObjC lÃ  má»™t superset cá»§a C vá»›i cÃ¡c tÃ­nh nÄƒng láº­p trÃ¬nh hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng. ObjC cho chÃºng ta concept vá» Ä‘á»‘i tÆ°á»£ng, cÃ¡c lá»›p vá»›i method vÃ  property cÅ©ng nhÆ° tÃ­nh káº¿ thá»«a cho ngÃ´n ngá»¯. Háº§u háº¿t cÃ¡c Ä‘á»‘i tÆ°á»£ng trong ObjC Ä‘á»u káº¿ thá»«a tá»« má»™t lá»›p cÆ¡ sá»Ÿ lÃ  <code class="language-plaintext highlighter-rouge">NSObject</code>. Sau Ä‘Ã¢y lÃ  má»™t code snippet Ä‘Æ¡n giáº£n cá»§a ObjC:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="n">Bob</span><span class="o">*</span> <span class="n">bob</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Bob</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
  <span class="p">[</span><span class="n">bob</span> <span class="nf">doSomething</span><span class="p">];</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Äoáº¡n snippet trÃªn khá»Ÿi táº¡o má»™t instance cá»§a má»™t lá»›p, sau Ä‘Ã³ gá»i má»™t method.</p>

<p>ObjC quáº£n lÃ½ ráº¥t cháº·t Ä‘á»‘i vá»›i thá»i háº¡n (lifetime) cá»§a cÃ¡c object. VÃ¬ tháº¿, má»i object Ä‘á»u cÃ³ má»™t bá»™ Ä‘áº¿m tham chiáº¿u (refcount) tá»“n táº¡i <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-private.h#L93">inline</a> hoáº·c trong má»™t <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/NSObject.mm#L201">global table</a>. Khi lÃ m viá»‡c vá»›i má»™t object, Ä‘oáº¡n code pháº£i thá»±c thi hai lá»‡nh gá»i lÃ  <a href="https://developer.apple.com/documentation/objectivec/1418956-nsobject/1571946-retain?language=objc">obj_retain</a> vÃ  <a href="https://developer.apple.com/documentation/objectivec/1418956-nsobject/1571957-release?language=objc">objc_release</a> lÃªn object. Hai hÃ m nÃ y pháº£i Ä‘Æ°á»£c thÃªm thá»§ cÃ´ng bá»Ÿi láº­p trÃ¬nh viÃªn hoáº·c <a href="https://en.wikipedia.org/wiki/Automatic_Reference_Counting">tá»± Ä‘á»™ng báº±ng compiler</a>.</p>

<p>Trong ná»™i bá»™, má»™t object cá»§a ObjC lÃ  má»™t chunk memory (thÆ°á»ng Ä‘Æ°á»£c khá»Ÿi táº¡o báº±ng <code class="language-plaintext highlighter-rouge">alloc</code>) luÃ´n báº¯t Ä‘áº§u vá»›i má»™t <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-private.h#L59">giÃ¡ trá»‹ â€œISAâ€</a> vÃ  theo sau bá»Ÿi cÃ¡c biáº¿n hoáº·c property. GiÃ¡ trá»‹ ISA lÃ  má»™t giÃ¡ trá»‹ kiá»ƒu con trá» cÃ³ chá»©a thÃ´ng tin sau:</p>

<ul>
  <li>Má»™t con trá» Ä‘áº¿n Lá»›p cá»§a object</li>
  <li>Má»™t inline refcount</li>
  <li>Má»™t vÃ i flag bit</li>
</ul>

<p>Má»™t <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-runtime-new.h#L1012">lá»›p ObjC</a> mÃ´ táº£ instance cá»§a nÃ³ vÃ  chÃ­nh nÃ³. CÃ¡c lá»›p trong ObjC khÃ´ng chá»‰ lÃ  má»™t khÃ¡i niá»‡m compile-time mÃ  chÃºng cÅ©ng tá»“n táº¡i á»Ÿ runtime. Má»™t lá»›p chá»©a cÃ¡c thÃ´ng tin sau:</p>

<ul>
  <li>Chá»¯ ISA (do nÃ³ lÃ  má»™t ObjC Object), trá» Ä‘áº¿n má»™t metaclass tÆ°Æ¡ng á»©ng</li>
  <li>Má»™t con trá» trá» Ä‘áº¿n má»™t lá»›p cha náº¿u cÃ³</li>
  <li>Má»™t method cache Ä‘á»ƒ tÄƒng tá»‘c method implementation lookups</li>
  <li>Method table</li>
  <li>Danh sÃ¡ch cÃ¡c instance variable (tÃªn vÃ  offset)</li>
</ul>

<p>Má»™t <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-runtime-new.h#L207">method</a> trong ObjC Ä‘Æ¡n giáº£n lÃ  má»™t tuple:</p>

<p>(<a href="https://developer.apple.com/documentation/objectivec/sel?language=objc">Selector</a>, <a href="https://developer.apple.com/documentation/objectivec/objective-c_runtime/imp?language=objc">Implementation</a>)</p>

<p>vá»›i Selector lÃ  má»™t chuá»—i C-String duy nháº¥t chá»©a tÃªn cá»§a method vÃ  Implementation lÃ  má»™t con trá» Ä‘áº¿n native function cá»§a method.</p>

<p>DÆ°á»›i Ä‘Ã¢y lÃ  nhá»¯ng gÃ¬ sáº½ xáº£y ra khi Ä‘oáº¡n code khi nÃ£y Ä‘Æ°á»£c compile vÃ  thá»±c thi: Äáº§u tiÃªn, á»Ÿ compile-time, ba lá»‡nh gá»i method ObjC Ä‘Æ°á»£c dá»‹ch sang má»™t Ä‘oáº¡n pseudo-C (giáº£ sá»­ ARC Ä‘ang Ä‘Æ°á»£c kÃ­ch hoáº¡t):</p>

<pre><code class="language-pseudocode">Bob* bob = objc_msgSend(BobClass, "alloc");
// Refcount is already 1 at this point, so no need for a objc_retain()
bob = objc_msgSend(bob, "init");
objc_msgSend(bob, "doSomething");
...
objc_release(bob);
</code></pre>

<p>Trong runtime, <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/Messengers.subproj/objc-msg-arm64.s#L252">objc_msgSend</a> sáº½ thá»±c thi:</p>

<ol>
  <li>Truy cáº­p vÃ o vÃ¹ng nhá»› cá»§a con trá» Ä‘á»ƒ thu giÃ¡ trá»‹ ISA vÃ  extract Class pointer</li>
  <li>Thá»±c hiá»‡n viá»‡c <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-runtime-new.mm#L4657">tÃ¬m kiáº¿m method implementation</a> trong method cache cá»§a Lá»›p.</li>
  <li>Náº¿u bÆ°á»›c 2 tháº¥t báº¡i, tiáº¿p tá»¥c tÃ¬m method trong method table</li>
  <li>Náº¿u má»™t method Implementation Ä‘Æ°á»£c tÃ¬m thÃ¡y, nÃ³ sáº½ Ä‘Æ°á»£c gá»i (Ä‘uÃ´i - Tailed Call) vá»›i nhá»¯ng tham sá»‘ tá»« objc_msgSend. Náº¿u fail thÃ¬ sáº½ throw exception.</li>
</ol>

<p>LÆ°u Ã½ ráº±ng vÃ¬ cÃ¡c selector lÃ  unique trong runtime, so sÃ¡nh hai selector vá»›i nhau cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Æ¡n giáº£n báº±ng viá»‡c so sÃ¡nh giÃ¡ trá»‹ cá»§a hai con trá» tÆ°Æ¡ng á»©ng,</p>

<p>Máº·t khÃ¡c, <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/NSObject.mm#L1505">objc_release</a> sáº½ <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-object.h#L464">giáº£m refcount</a> cá»§a object. Náº¿u nhÆ° refcount cá»§a object Ä‘Ã£ báº±ng khÃ´ng thÃ¬ nÃ³ sáº½ <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-object.h#L571">gá»i</a> method <a href="https://developer.apple.com/documentation/objectivec/nsobject/1571947-dealloc">dealloc_method</a> (deconstructor cá»§a object) vÃ  sau Ä‘Ã³ giáº£i phÃ³ng object memory chunk.</p>

<p>Má»™t sá»‘ thÃ´ng tin khÃ¡c cÃ³ thá»ƒ tÃ¬m tháº¥y á»Ÿ <a href="http://www.phrack.org/issues/66/4.html#article">Ä‘Ã¢y</a>, <a href="http://www.phrack.org/issues/69/9.html#article">Ä‘Ã¢y</a> vÃ  trong <a href="https://github.com/opensource-apple/objc4">source</a>/<a href="https://ipsw.me/">binary</a> code.</p>

<h2 id="native-code-execution-trÃªn-cÃ¡c-thiáº¿t-bá»‹-non-pac">Native Code Execution trÃªn cÃ¡c Thiáº¿t bá»‹ non-PAC</h2>

<p>Qua nhá»¯ng kiáº¿n thá»©c cÃ³ Ä‘Æ°á»£c vá» ObjC trÃªn káº¿t há»£p vá»›i nhá»¯ng thá»© cÃ³ Ä‘Æ°á»£c á»Ÿ pháº§n hai cá»§a series, ta cÃ³ thá»ƒ implement má»™t exploit Ä‘Æ¡n giáº£n Ä‘á»ƒ trigger NCE trÃªn cÃ¡c thiáº¿t bá»‹ non-PAC, ná»•i báº­t lÃ  iPhone X vÃ  nhá»¯ng Ä‘á»i trÆ°á»›c.</p>

<p>Sau Ä‘Ã¢y lÃ  má»™t Ä‘oáº¡n code nhá» tá»« <code class="language-plaintext highlighter-rouge">[NSSharedKeyset indexForKey:]</code>. Äoáº¡n code nÃ y sáº½ lÆ°á»£c qua cÃ¡c giÃ¡ trá»‹ phÃ¹ há»£p do ngÆ°á»i táº¥n cÃ´ng chá»n (vá»›i <code class="language-plaintext highlighter-rouge">_keys</code> lÃ  nullptr vÃ  <code class="language-plaintext highlighter-rouge">index </code>Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm soÃ¡t) vÃ  xá»­ lÃ½ chÃºng.</p>

<pre><code class="language-objective-c">id candidate = self-&gt;_keys[index];
  if (candidate != nil) {
    if ([key isEqual:candidate]) {
      return prevLength + index;
    }
  }
</code></pre>
<p>Náº¿u key lÃ  mÃ´t NSString, thÃ¬</p>

:ET